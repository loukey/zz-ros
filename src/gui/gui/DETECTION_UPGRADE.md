# DetectionModel YOLO11 升级说明

## 概述

本次升级将 `DetectionModel` 从模拟检测改为使用真实的 YOLO11 深度学习模型进行对象检测，并实现了彩色图像检测与深度信息融合的功能。

## 主要修改

### 1. DetectionModel 类修改

#### 新增功能
- **YOLO11集成**: 在初始化时自动创建 `YOLO11DetectionModel` 实例
- **深度值获取**: 新增 `get_depth_at_position()` 方法，用于获取彩色图像中心点对应的深度值
- **智能深度估算**: 当指定像素深度值无效时，自动计算周围5x5区域的平均深度

#### 修改的方法
- `__init__()`: 增加YOLO11检测器初始化
- `enable_detection()`: 增加YOLO11模型可用性检查
- `is_camera_available()`: 现在要求同时具备彩色和深度图像
- `process_detection()`: 完全重写，只处理彩色图像检测并融合深度信息
- `detect_objects()`: 更新为使用YOLO11检测器

### 2. YOLO11DetectionModel 类改进

#### 功能增强
- **完整边界框**: 从YOLO检测结果正确提取和转换边界框格式
- **分割掩码处理**: 支持实例分割，计算对象方向角度
- **回退检测**: 当分割不可用时，回退到边界框检测
- **GPU内存管理**: 自动清理CUDA缓存，防止内存泄漏

#### 修复的方法
- `detect_objects()`: 修复了边界框提取逻辑，增加了错误处理
- `draw_orientation_arrow()`: 修复了方法签名（添加self参数）

### 3. CameraController 修改

#### 检测显示增强
- **详细标签**: 显示类别、置信度、中心点坐标、方向角和深度值
- **多行标签**: 支持多行信息显示，自动调整标签位置
- **视觉增强**: 绘制中心点、方向箭头和统计信息
- **检测管理**: 改进检测开启/关闭流程

#### 修改的方法
- `_draw_detection_boxes()`: 完全重写，支持丰富的检测结果显示
- `start_detection()`: 增加DetectionModel启用逻辑
- `stop_detection()`: 增加DetectionModel禁用逻辑

## 新增功能特性

### 1. 深度感知检测
- 在彩色图像中检测对象
- 自动获取对象中心点对应的深度值
- 智能深度插值（当单点深度无效时）

### 2. 对象方向检测
- 使用PCA算法计算对象主轴方向
- 显示方向角度（相对于水平轴）
- 绘制方向指示箭头

### 3. 实时检测统计
- 显示检测对象数量
- 显示检测耗时
- 右上角实时统计信息显示

### 4. 丰富的视觉反馈
- 绿色边界框
- 蓝色中心点
- 黄色方向箭头
- 多行信息标签
- 实时统计显示

## 使用方法

### 在GUI中使用
1. 打开主程序，切换到"摄像头"标签
2. 点击"连接摄像头"按钮
3. 点击"显示彩色图"开始显示图像
4. 点击"开始检测"按钮启动YOLO11检测
5. 检测结果将实时叠加在图像上显示

### 检测结果信息
每个检测到的对象会显示：
- **类别和置信度**: 如 "person: 0.85"
- **中心点坐标**: 如 "Center: (320.5, 240.1)"
- **方向角度**: 如 "Angle: 45.2°"
- **深度信息**: 如 "Depth: 1.234m" 或 "Depth: N/A"

## 技术细节

### 坐标系统
- 图像坐标系：左上角为原点(0,0)，x轴向右，y轴向下
- 深度值单位：米(m)
- 角度单位：度(°)，相对于水平轴

### 性能优化
- 使用GPU加速（如果可用）
- 自动内存管理和清理
- 智能深度插值减少计算量

### 错误处理
- YOLO11模型初始化失败检测
- 相机连接状态检查
- 图像数据有效性验证
- 深度值有效性检查

## 依赖要求

```python
torch>=1.9.0
ultralytics>=8.0.0
opencv-python>=4.5.0
scikit-learn>=1.0.0
numpy>=1.21.0
PyQt5>=5.15.0
```

## 测试

运行测试脚本验证功能：

```bash
cd src/gui/gui
python test_detection.py
```

测试内容包括：
- YOLO11模型加载和初始化
- DetectionModel集成测试
- 检测功能完整性测试

## 注意事项

1. **首次运行**: YOLO11模型会自动下载权重文件（约200MB）
2. **GPU要求**: 推荐使用CUDA兼容的GPU以获得最佳性能
3. **内存使用**: 检测过程会占用较多GPU/CPU内存
4. **相机要求**: 需要同时支持彩色和深度图像的相机设备

## 故障排除

### 常见问题
1. **YOLO11初始化失败**: 检查网络连接，确保能下载模型权重
2. **检测无结果**: 确保图像质量良好，光照充足
3. **深度值为N/A**: 检查深度相机是否正常工作
4. **性能较慢**: 考虑升级GPU或降低图像分辨率

### 调试建议
- 查看控制台输出的详细错误信息
- 使用测试脚本验证各组件功能
- 检查相机连接和图像数据质量 