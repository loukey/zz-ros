# 相机标定模块使用说明

## 功能介绍

本模块提供了完整的ROS2相机标定功能，包括：

- 实时订阅相机话题
- 交互式图像收集
- 自动棋盘格角点检测
- 相机内参和畸变系数标定
- 标定结果保存和加载

## 依赖安装

首先确保安装了必要的依赖：

```bash
# 安装ROS2依赖
sudo apt install ros-humble-cv-bridge ros-humble-sensor-msgs

# 安装Python依赖
pip install opencv-python numpy PyYAML
```

## 使用方法

### 1. 编译包

```bash
cd /home/za/Codes/zzros
colcon build --packages-select camera
source install/setup.bash
```

### 2. 启动相机标定节点

#### 方法一：直接使用ROS2命令

```bash
ros2 run camera camera_calibration
```

#### 方法二：使用启动脚本

```bash
cd src/camera
python3 launch_calibration.py --camera_topic /camera/image_raw
```

#### 方法三：自定义参数启动

```bash
ros2 run camera camera_calibration --ros-args \
    -p camera_topic:=/your_camera/image_raw \
    -p chessboard_size:=9,6 \
    -p square_size:=0.025 \
    -p save_dir:=./my_calibration_data \
    -p min_samples:=15
```

## 参数说明

| 参数名称 | 默认值 | 说明 |
|----------|--------|------|
| `camera_topic` | `/camera/image_raw` | 相机图像话题名称 |
| `chessboard_size` | `9,6` | 棋盘格内角点数目 (宽,高) |
| `square_size` | `0.025` | 棋盘格方格边长(米) |
| `save_dir` | `./calibration_data` | 标定数据保存目录 |
| `min_samples` | `20` | 最少标定图像数量 |

## 标定流程

### 1. 准备工作

- 打印棋盘格标定板（推荐A4纸，9x6内角点）
- 确保相机话题正常发布图像
- 准备好光照充足的标定环境

### 2. 启动标定节点

运行节点后会看到交互式界面：

```
============================================================
相机标定交互界面
============================================================
命令说明:
  start    - 开始收集标定图像
  stop     - 停止收集标定图像
  calibrate - 执行相机标定
  status   - 显示当前状态
  clear    - 清除已收集的图像
  load     - 加载标定结果
  quit     - 退出程序
============================================================
在收集模式下，按空格键保存当前图像用于标定
============================================================
```

### 3. 收集标定图像

1. 输入 `start` 开始收集模式
2. 将棋盘格放在相机前不同位置和角度
3. 当检测到棋盘格角点时，按 **空格键** 保存图像
4. 收集至少20张不同角度的标定图像
5. 输入 `stop` 停止收集

### 4. 执行标定

输入 `calibrate` 开始相机标定，程序会自动：
- 处理所有收集的图像
- 计算相机内参矩阵
- 计算畸变系数
- 评估标定精度
- 保存标定结果

### 5. 标定结果

标定完成后会显示详细结果：

```
==================================================
相机标定结果
==================================================
图像尺寸: 640 x 480
标定图像数量: 25
RMS误差: 0.234567
平均重投影误差: 0.123456 像素

相机内参矩阵:
[[525.123  0.     320.456]
 [  0.    526.789 240.123]
 [  0.      0.      1.   ]]

焦距 (fx, fy): (525.12, 526.79)
主点 (cx, cy): (320.46, 240.12)

畸变系数:
k1: -0.123456
k2: 0.234567
p1: -0.001234
p2: 0.002345
k3: -0.345678
==================================================
```

## 输出文件

标定完成后会在指定目录生成以下文件：

- `camera_calibration.yaml` - YAML格式的标定参数
- `camera_calibration.npz` - NumPy格式的标定参数
- `calib_image_*.jpg` - 收集的标定图像

### YAML文件格式示例

```yaml
camera_matrix:
- [525.123, 0.0, 320.456]
- [0.0, 526.789, 240.123]
- [0.0, 0.0, 1.0]
distortion_coefficients:
- [-0.123456, 0.234567, -0.001234, 0.002345, -0.345678]
image_size: [640, 480]
rms_error: 0.234567
mean_reprojection_error: 0.123456
num_images: 25
chessboard_size: [9, 6]
square_size: 0.025
calibration_date: '2024-01-15T10:30:45.123456'
```

## 命令参考

在运行时可以使用以下命令：

- `start` - 开始收集标定图像
- `stop` - 停止收集模式
- `calibrate` - 执行相机标定
- `status` - 查看当前状态
- `clear` - 清除已收集的图像
- `load` - 加载之前的标定结果
- `quit` - 退出程序

## 注意事项

1. **棋盘格要求**：
   - 使用黑白相间的棋盘格
   - 确保打印质量良好，边缘清晰
   - 棋盘格应平整，无弯曲

2. **图像收集建议**：
   - 在不同位置、角度、距离拍摄
   - 覆盖相机视野的各个区域
   - 避免模糊、过暗、过亮的图像
   - 至少收集20张高质量图像

3. **环境要求**：
   - 光照充足且均匀
   - 避免强烈反光
   - 相机固定，避免抖动

4. **精度评估**：
   - RMS误差应小于1.0
   - 重投影误差应小于0.5像素
   - 如果误差较大，需要重新收集图像

## 故障排除

### 1. 检测不到棋盘格
- 检查棋盘格是否平整
- 调整光照条件
- 确认棋盘格尺寸参数正确

### 2. 标定精度不佳
- 增加标定图像数量
- 提高图像质量
- 增加视角多样性

### 3. 程序运行错误
- 检查ROS2话题是否正常
- 确认依赖包已安装
- 检查相机权限

## 扩展功能

可以基于此模块进一步开发：
- 立体相机标定
- 相机-激光雷达标定
- 实时图像去畸变
- 标定精度评估工具 